#+TITLE: CEmacs
#+AUTHOR: Chithresh
#+STARTUP: content

* Elpaca
** Bootstrap
#+begin_src emacs-lisp
  (defvar elpaca-installer-version 0.11)
  (defvar elpaca-directory (expand-file-name "elpaca/" user-emacs-directory))
  (defvar elpaca-builds-directory (expand-file-name "builds/" elpaca-directory))
  (defvar elpaca-repos-directory (expand-file-name "repos/" elpaca-directory))
  (defvar elpaca-order '(elpaca :repo "https://github.com/progfolio/elpaca.git"
                                :ref nil :depth 1 :inherit ignore
                                :files (:defaults "elpaca-test.el" (:exclude "extensions"))
                                :build (:not elpaca--activate-package)))
  (let* ((repo  (expand-file-name "elpaca/" elpaca-repos-directory))
         (build (expand-file-name "elpaca/" elpaca-builds-directory))
         (order (cdr elpaca-order))
         (default-directory repo))
    (add-to-list 'load-path (if (file-exists-p build) build repo))
    (unless (file-exists-p repo)
      (make-directory repo t)
      (when (<= emacs-major-version 28) (require 'subr-x))
      (condition-case-unless-debug err
          (if-let* ((buffer (pop-to-buffer-same-window "*elpaca-bootstrap*"))
                    ((zerop (apply #'call-process `("git" nil ,buffer t "clone"
                                                    ,@(when-let* ((depth (plist-get order :depth)))
                                                        (list (format "--depth=%d" depth) "--no-single-branch"))
                                                    ,(plist-get order :repo) ,repo))))
                    ((zerop (call-process "git" nil buffer t "checkout"
                                          (or (plist-get order :ref) "--"))))
                    (emacs (concat invocation-directory invocation-name))
                    ((zerop (call-process emacs nil buffer nil "-Q" "-L" "." "--batch"
                                          "--eval" "(byte-recompile-directory \".\" 0 'force)")))
                    ((require 'elpaca))
                    ((elpaca-generate-autoloads "elpaca" repo)))
              (progn (message "%s" (buffer-string)) (kill-buffer buffer))
            (error "%s" (with-current-buffer buffer (buffer-string))))
        ((error) (warn "%s" err) (delete-directory repo 'recursive))))
    (unless (require 'elpaca-autoloads nil t)
      (require 'elpaca)
      (elpaca-generate-autoloads "elpaca" repo)
      (let ((load-source-file-function nil)) (load "./elpaca-autoloads"))))
  (add-hook 'after-init-hook #'elpaca-process-queues)
  (elpaca `(,@elpaca-order))
#+end_src

** Use-Package Support
Install use-package support for elpaca
#+begin_src emacs-lisp
  (elpaca elpaca-use-package
    (elpaca-use-package-mode))

  ;; Install all packages  by default, instead of :ensure t for every package
  ;; Specifiy :ensure nil for packages which should not be installed automatically (i.e. for built-in packages)
  (setq use-package-always-ensure t)
#+end_src

* No Littering
Cleanup emacs config directory
#+begin_src emacs-lisp
  (use-package no-littering
    :custom
    (custom-file (no-littering-expand-etc-file-name "custom.el"))
    :config
    (no-littering-theme-backups))
#+end_src

* Appearance
** Theme
Modus theme config
#+begin_src emacs-lisp
  (setq modus-themes-italic-constructs t
        modus-themes-bold-constructs t
        modus-themes-mixed-fonts t
        modus-themes-headings '((1 . (1.5))
                                (2 . (1.3))
                                (t . (1.1))))

  ;; Load the dark theme by default
  (load-theme 'modus-vivendi-tinted t)
#+end_src

** Fonts
#+begin_src emacs-lisp
  ;; Set default, fixed and variable pitch fonts
  (use-package mixed-pitch
    :hook
    (text-mode . mixed-pitch-mode))

  (set-face-attribute 'default nil :font "Iosevka Fixed Extended-11")
  (set-face-attribute 'fixed-pitch nil :font "Iosevka Fixed Extended-11")
  (set-face-attribute 'variable-pitch nil :font "Iosevka Aile")
#+end_src

** Icons
#+begin_src emacs-lisp
  (use-package all-the-icons
    :if (display-graphic-p)
    :demand t)

  ;; Use icons in dired
  (use-package all-the-icons-dired
    :demand t
    :hook
    (dired-mode . all-the-icons-dired-mode))

  (use-package all-the-icons-completion
    :after (marginalia all-the-icons)
    :demand t
    :hook (marginalia-mode . all-the-icons-completion-marginalia-setup)
    :init (all-the-icons-completion-mode))
#+end_src

** Line & Column Numbers
#+begin_src emacs-lisp
  (global-display-line-numbers-mode 1)       ; Enable line numbers
  (global-visual-line-mode t)                ; Enable visual line mode globally
  ;; Set symbols for line wrap
  (setq visual-line-fringe-indicators '(left-curly-arrow right-curly-arrow))
  (setq display-line-numbers-type 'visual    ; Visual line numbers (or relative)
        display-line-numbers-width 5         ; Set the width for line numbers display
        display-line-numbers-width-start t   ; Ensure the width adjusts only once at startup
        column-number-mode t)                ; Set column numbers
#+end_src

* Packages Config
** Emacs
Changing some bad defaults
#+begin_src emacs-lisp
  (use-package emacs
    :demand t
    :ensure nil
    :init
    ;; More than one minibuffer
    (setq enable-recursive-minibuffers t)

    ;; Use y or n instead of yes or no
    (setq use-short-answers t)

    ;; Copy instead of moving for backups
    (setq backup-by-copying t)

    ;; Don't consider double space as sentence end
    (setq sentence-end-double-space nil)

    ;; Don't resize the fame after its contents change
    (setq frame-inhibit-implied-resize t)

    ;; setq-default sets the buffer local variables value in all buffers
    ;; Use spaces instead of tabs
    (setq-default indent-tabs-mode nil)

    ;; Escape quits everything
    (global-set-key (kbd "<escape>") 'keyboard-escape-quit)

    (setq delete-by-moving-to-trash t)

    ;; Highlights matching parentheses
    (show-paren-mode t))
#+end_src

** Evil
*** Evil Mode
#+begin_src emacs-lisp
  (use-package evil
    :demand t
    :init
    ;; J & K respects wrapped lines
    (setq evil-respect-visual-line-mode t)

    ;; Use emacs' built-in search functionality.
    (setq evil-search-module 'isearch)

    ;; Allow scroll up with 'C-u'
    (setq evil-want-C-u-scroll t)

    ;; Allow scroll down with 'C-d'
    (setq evil-want-C-d-scroll t)

    ;; Necessary for evil collection
    (setq evil-want-integration t)
    (setq evil-want-keybinding nil)

    ;; Making sure that the tab key is bound for 'org-cycle'
    ;; This is to fix the 'TAB' key in some cases (like in terminal version)
    ;; (setq evil-want-C-i-jump nil)

    ;; 'u' for undo and 'C-r' for redo
    (setq evil-undo-system 'undo-redo)

    ;; Conditions for splitting windows
    (setq evil-vsplit-window-right t)
    (setq evil-split-window-below t)

    :config
    ;; Enable evil mode globally
    (evil-mode t)

    ;; Set the initial state for some kinds of buffers.
    (evil-set-initial-state 'messages-buffer-mode 'normal))
#+end_src

*** Evil Collection
#+begin_src emacs-lisp
  (use-package evil-collection
    :after evil
    :custom
    ;; Enable evil mode in minibuffer
    (evil-collection-setup-minibuffer t)
    :config
    (evil-collection-init))
#+end_src

*** Evil Commentary
Make it easy to comment out (lines of) code in evil mode
#+begin_src emacs-lisp
  (use-package evil-commentary
    :after evil
    :config
    ;; Globally enable evil-commentary
    (evil-commentary-mode))
#+end_src

*** Evil Surround
#+begin_src emacs-lisp
  (use-package evil-surround
    :after evil
    :config
    ;; Globally enable evil-surround
    (global-evil-surround-mode 1))
#+end_src

*** Evil Goggles
Show visual hints for evil motions
#+begin_src emacs-lisp
  (use-package evil-goggles
    :config
    (evil-goggles-mode)

    ;; optionally use diff-mode's faces; as a result, deleted text
    ;; will be highlighed with `diff-removed` face which is typically
    ;; some red color (as defined by the color theme)
    ;; other faces such as `diff-added` will be used for other actions
    (evil-goggles-use-diff-faces))
#+end_src

** General
#+begin_src emacs-lisp
  (use-package general
    :ensure (:wait t)
    :demand t
    :config
    ;; Integrate general with evil
    (general-evil-setup)

    ;; Set up 'SPC' as the global leader key
    (general-create-definer chithresh/leader-keys
      :states '(normal insert visual emacs)
      :keymaps 'override
      :prefix "SPC"
      ;; Leader in insert mode
      :global-prefix "M-SPC"))
#+end_src

** Modeline
*** Minions
#+begin_src emacs-lisp
  (use-package minions
    :ensure t
    :config
    (minions-mode 1))
#+end_src

** Minibuffer
*** Vertico
Minibuffer completions (vertical)
#+begin_src emacs-lisp
  (use-package vertico
    :init
    (vertico-mode)
    :custom
    (vertico-cycle t)
    (vertico-sort-function 'vertico-sort-history-alpha))
#+end_src

*** SaveHist
Persist history over Emacs restarts
#+begin_src emacs-lisp
  (use-package savehist
    :ensure nil
    :init
    (savehist-mode))
#+end_src

*** Orderless
Matches patterns, irrespective of the order they are typed in
#+begin_src emacs-lisp
  (use-package orderless
     :custom
     (completion-styles '(orderless basic))
     (completion-category-defaults nil)
     (completion-category-overrides
      '((file (styles partial-completion)))))
#+end_src

*** Marginalia
Displays the documentation next to the completion candidates
#+begin_src emacs-lisp
  (use-package marginalia
      :init
      (marginalia-mode))
#+end_src

** Dired
#+begin_src emacs-lisp
  (use-package dired
    :ensure nil  ; Built-in
    :defer t
    :hook
      (dired-mode . dired-hide-details-mode))
    :config
      (setq dired-listing-switches "-aBhl  --group-directories-first")
      (setq dired-kill-when-opening-new-dired-buffer t)  ; Open all Directories in the Same Dired Buffer
#+end_src

** Shell
Config for M-x Shell
#+begin_src emacs-lisp
  (setq explicit-shell-file-name "/usr/bin/bash")
  (setq comint-prompt-read-only t)  ; Make Shell Prompt Read Only
#+end_src

** Tramp
#+begin_src emacs-lisp
  ;; Setup bash as default shell for all tramp connections
  (connection-local-set-profile-variables 'remote-bash
     '((shell-file-name . "/usr/bin/bash")
       (shell-command-switch . "-lc")  ; -l is required to load ENV variables & PATH
       (shell-interactive-switch . "-i")
       (shell-login-switch . "-l")))
  (connection-local-set-profiles
     '(:application tramp) 'remote-bash)
#+end_src

** Magit
#+begin_src emacs-lisp
  ;; Requirement to install Magit
  (use-package transient)
  ;; Install Magit
  (use-package magit)
#+end_src

** Which Key
#+begin_src emacs-lisp
  (use-package which-key
    :ensure nil  ; Built-in
    :config
    (which-key-mode))
#+end_src

** Other
*** Electric
#+begin_src emacs-lisp
  (use-package electric
    :demand t
    :ensure nil
    :init
    ;; Automatically insert closing parens
    (electric-pair-mode +1)
    ;; More annoying than useful
    (setq electric-pair-preserve-balance nil))
#+end_src

*** Ediff
#+begin_src emacs-lisp
  (use-package ediff
    :demand t
    :ensure nil
  )
#+end_src

*** Engraved Faces
For properly formatting code blocks in org-mode latex export
#+begin_src emacs-lisp
  (use-package engrave-faces)
#+end_src

*** Modeline Bell
Blinking the modeline instead of visual bell
#+begin_src emacs-lisp
  (use-package mode-line-bell
    :custom
    (mode-line-bell-mode t))
#+end_src

* Org
** Custom Options
*** Todo Keywords
Setting & customizing the todo keywords in orgmode
#+begin_src emacs-lisp
  (setq org-todo-keywords
        '((sequence "TODO" "NEXT" "IN-PROGRESS" "DONE")))

  (setq org-todo-keyword-faces
        '(("TODO" . (:foreground "dark red" :weight bold :slant italic))
          ("NEXT" . (:foreground "orange red" :weight bold :slant italic))
          ("IN-PROGRESS" . (:foreground "dodger blue" :weight bold :slant italic))
          ("DONE" . (:foreground "green" :weight bold :slant italic))))
#+end_src

** Ox-Pandoc
For file conversion using pandoc
#+begin_src emacs-lisp
  (use-package ox-pandoc)
#+end_src

** Babel
#+begin_src emacs-lisp
  (org-babel-do-load-languages
    'org-babel-load-languages
    '((python . t)
      (shell . t)
      (gnuplot . t)
      (fortran . t)
      (latex . t)
      (emacs-lisp . t)))
#+end_src

** Latex Export
#+begin_src emacs-lisp
  (setq org-latex-src-block-backend 'engraved)            ; Set src block formatting backend to Engraved
  (setq org-latex-engraved-theme 'modus-operandi-tinted)  ; Set doom-one-light theme for Latex Code Block Export
#+end_src

* Research Tools
** Vasp
Some useful stuff for Vasp
#+begin_src emacs-lisp
  ;; Basic syntax highlighting for vasp input files
  (add-to-list 'auto-mode-alist '("INCAR.*\\'" . conf-mode))
#+end_src

** HPC Connections
Automating connections to HPC's
#+begin_src emacs-lisp
  (defun open-hpc1-directory ()
  "Open a remote directory in HPC 1 using Tramp."
  (interactive)
  (find-file "/sshx:hpc1:~/scratch/chithresh/Calculations"))

  (defun open-hpc2-directory ()
  "Open a remote directory in HPC 2 using Tramp."
  (interactive)
  (find-file "/sshx:hpc2:~/Calculations"))
#+end_src

* Keybindings
** Overrides
#+begin_src emacs-lisp
  ;; x deletes char but does not copy it to clipboard
  (define-key evil-normal-state-map "x" 'delete-char)
#+end_src

** General
*** Single Keys
#+begin_src emacs-lisp
  (chithresh/leader-keys
    ;; An alternative to 'M-x'
    "SPC" '(execute-extended-command :wk "Execute Command")
    ;; Open dired
    "." '(dired-jump :wk "Open Dired")
    ;; Quit emacs
    "q" '(evil-quit :wk "Quit")
    ;; Window movement
    "k" '(windmove-up :wk "Window Up")
    "j" '(windmove-down :wk "Window Down")
    "h" '(windmove-left :wk "Window Left")
    "l" '(windmove-right :wk "Window Right")
    ;; Magit
    "g" '(magit-status :wk "Magit"))
#+end_src

*** Files
#+begin_src emacs-lisp
  (chithresh/leader-keys
    "f" '(:ignore t :wk "File")
    "f f" '(find-file :wk "Find File")
    "f c" '((lambda() (interactive)(find-file "~/.config/emacs/README.org")) :wk "Emacs Config")
    "f s" '(evil-write :wk "Save")
    "f r" '(recentf-open :wk "Open Recent Files"))
#+end_src

*** Buffers
#+begin_src emacs-lisp
  (chithresh/leader-keys
    "b" '(:ignore t :wk "Buffer")
    "b b" '(switch-to-buffer :wk "Switch Buffer")
    "b k" '(kill-buffer :wk "Kill Buffer")
    "b i" '(ibuffer :wk "IBuffer")
    "b n" '(next-buffer :wk "Next Buffer")
    "b p" '(previous-buffer :wk "Previous Buffer")
    "b r" '(revert-buffer :wk "Reload Buffer"))
#+end_src

*** Org
#+begin_src emacs-lisp
  (chithresh/leader-keys
    "o" '(:ignore t :wk "Org")
    "o t" '(org-toggle-checkbox :wk "Toggle Checkbox"))
#+end_src

*** Remote
#+begin_src emacs-lisp
  (chithresh/leader-keys
    "r" '(:ignore t :wk "Remote")
    ;; Custom functions defined in HPC Connections section
    "r 1" '(open-hpc1-directory :wk "Connect to HPC1")  
    "r 2" '(open-hpc2-directory :wk "Connect to HPC2"))
#+end_src

